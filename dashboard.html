<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#020617;
  color:white;
  font-family: Inter, Arial;
  margin:0;
}

.header{
  background:#020617;
  padding:18px 25px;
  font-size:22px;
  font-weight:900;
  border-bottom:1px solid #0f172a;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
}

.card{
  background:rgba(15,23,42,.75);
  margin:15px;
  padding:15px;
  border-radius:18px;
  box-shadow:0 0 25px rgba(0,0,0,0.4);
  border:1px solid #1f2937;
}

.badge-online{color:#10b981;font-weight:bold;}
.badge-offline{color:#ef4444;font-weight:bold;}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  border-bottom:1px solid #1e293b;
  padding:10px;
  font-size:14px;
}

.time{
  font-family: monospace;
  color:#a5b4fc;
}
.logitem{
  margin:4px 0;
}
</style>

</head>
<body>

<div class="header">CyberMonitor â€” Live Security Dashboard</div>

<div class="grid">

<div class="card">
  <h3>User / Device Status</h3>

  <p><b>Email:</b> <span id="email"></span></p>
  <p><b>Machine:</b> <span id="machine"></span></p>
  <p><b>Status:</b> <span id="status"></span></p>
  <p><b>Last Seen:</b> <span id="last_seen" class="time"></span></p>
</div>

<div class="card">
  <h3>Connected External USB Devices</h3>
  <table id="usb_table">
    <tr>
      <th>Device Name</th>
      <th>Token</th>
    </tr>
  </table>
</div>

</div>

<div class="card">
  <h3>Security Logs</h3>
  <div id="logs"></div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
  authDomain:"cybermonitor-1ab3c.firebaseapp.com",
  projectId:"cybermonitor-1ab3c"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(user=>{
  if(!user){window.location="login.html";return;}
  start(user.uid,user.email);
});

function toIST(utcString){
  let d = new Date(utcString);
  let IST = new Date(d.getTime() + 5.5*60*60*1000);

  let dd = String(IST.getDate()).padStart(2,'0');
  let mm = String(IST.getMonth()+1).padStart(2,'0');
  let yy = IST.getFullYear();

  let hh = String(IST.getHours()).padStart(2,'0');
  let mi = String(IST.getMinutes()).padStart(2,'0');
  let ss = String(IST.getSeconds()).padStart(2,'0');

  return `${dd}.${mm}.${yy} ${hh}:${mi}:${ss}`;
}

function start(uid,email){

  document.getElementById("email").innerText=email;

  db.doc(`users/${uid}`).onSnapshot(doc=>{
    if(!doc.exists) return;

    let d = doc.data();

    document.getElementById("machine").innerText = d.machine || "Unknown";

    // ONLINE logic based on last_seen
    let last = new Date(d.last_seen);
    let now = new Date();
    let diff = (now - last)/1000;

    if(diff < 10)
      document.getElementById("status").innerHTML="<span class='badge-online'>ONLINE</span>";
    else
      document.getElementById("status").innerHTML="<span class='badge-offline'>OFFLINE</span>";

    document.getElementById("last_seen").innerText = toIST(d.last_seen);
  });

  db.doc(`users/${uid}/status/usb_status`).onSnapshot(doc=>{
    const table = document.getElementById("usb_table");
    table.innerHTML="<tr><th>Device Name</th><th>Token</th></tr>";

    if(!doc.exists) return;

    let arr = doc.data().usb_devices?.values || [];

    arr.forEach(v=>{
      let f=v.mapValue.fields;
      let row=document.createElement("tr");
      row.innerHTML=`
        <td>${f.device_name.stringValue}</td>
        <td>${f.token.stringValue}</td>
      `;
      table.appendChild(row);
    });

  });

  db.collection(`users/${uid}/logs`)
   .orderBy("timestamp","desc")
   .limit(25)
   .onSnapshot(snap=>{
      const box=document.getElementById("logs");
      box.innerHTML="";

      snap.forEach(doc=>{
        let d=doc.data();
        let div=document.createElement("div");
        div.className="logitem";

        let color="#9ca3af";
        if(d.severity==="HIGH")color="#f97316";
        if(d.severity==="CRITICAL")color="#ef4444";

        div.style.color=color;
        div.innerText=`${toIST(d.timestamp)} - ${d.message}`;
        box.appendChild(div);
      });
   });
}
</script>

</body>
</html>
