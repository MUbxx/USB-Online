<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CyberMonitor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        body { background: #0b1220; color: #e5e7eb; font-family: sans-serif; }
        .card { background: #101a33; border: 1px solid #1e2b4d; border-radius: 12px; padding: 20px; }
        .dot-online { background: #16a34a; box-shadow: 0 0 8px #16a34a; }
        .dot-offline { background: #dc2626; box-shadow: 0 0 8px #dc2626; }
    </style>
</head>
<body class="p-10">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-bold text-blue-400">CyberMonitor Control Panel</h1>
            <button onclick="auth.signOut()" class="text-red-400 hover:underline">Logout</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="card">
                <p class="text-sm text-gray-400">Agent Status</p>
                <div class="flex items-center gap-2 mt-2">
                    <span id="connDot" class="w-3 h-3 rounded-full dot-offline"></span>
                    <span id="connText" class="font-bold">Offline</span>
                </div>
            </div>
            <div class="card">
                <p class="text-sm text-gray-400">System User</p>
                <div id="sysUser" class="text-xl font-bold mt-2">...</div>
            </div>
            <div class="card">
                <p class="text-sm text-gray-400">Active Account</p>
                <div id="accEmail" class="text-xl font-bold mt-2 truncate">...</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="card">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Detected USB Storage</h2>
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-gray-500 text-sm">
                            <th>Vendor</th>
                            <th>Device</th>
                            <th>Serial</th>
                        </tr>
                    </thead>
                    <tbody id="usbTable"></tbody>
                </table>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Security Logs</h2>
                <div id="logBox" class="h-64 overflow-y-auto text-sm font-mono space-y-1"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
            authDomain: "cybermonitor-1ab3c.firebaseapp.com",
            projectId: "cybermonitor-1ab3c",
            storageBucket: "cybermonitor-1ab3c.appspot.com",
            messagingSenderId: "569408987884",
            appId: "1:569408987884:web:0839eb7932c206fc157bc9"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(user => {
            if (!user) { window.location = "login.html"; return; }
            document.getElementById("accEmail").innerText = user.email;
            
            // Listen for Machine Status
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                const data = doc.data();
                if (!data) return;
                document.getElementById("sysUser").innerText = data.active_user;
                const lastSeen = new Date(data.last_seen);
                const isOnline = (new Date() - lastSeen) < 40000;
                document.getElementById("connDot").className = isOnline ? "w-3 h-3 rounded-full dot-online" : "w-3 h-3 rounded-full dot-offline";
                document.getElementById("connText").innerText = isOnline ? "Online" : "Offline";
            });

            // Listen for USBs
            db.collection("users").doc(user.uid).collection("status").doc("usb_status").onSnapshot(doc => {
                const list = doc.data()?.usb_devices || [];
                const t = document.getElementById("usbTable");
                t.innerHTML = list.map(d => `
                    <tr class="border-b border-gray-800">
                        <td class="py-2 text-gray-400">${d.vendor}</td>
                        <td class="py-2 font-bold">${d.device_name}</td>
                        <td class="py-2 text-blue-400 text-xs">${d.serial}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3" class="py-4 text-center text-gray-600">No drives found</td></tr>';
            });

            // Listen for Logs
            db.collection("users").doc(user.uid).collection("logs").orderBy("timestamp", "desc").limit(20).onSnapshot(s => {
                document.getElementById("logBox").innerHTML = s.docs.map(doc => {
                    const d = doc.data();
                    const color = d.severity === "HIGH" ? "text-red-400" : "text-gray-400";
                    return `<p><span class="text-blue-500">[LOG]</span> <span class="${color}">${d.message}</span></p>`;
                }).join('');
            });
        });
    </script>
</body>
</html>
