<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background: radial-gradient(circle at top, #020617, #01030a);
  color:#e5e7eb;
  font-family: Inter, system-ui, sans-serif;
}
.glass{
  background:rgba(2,12,27,.85);
  backdrop-filter: blur(12px);
  border:1px solid rgba(255,255,255,.05);
}
.tab-btn.active{
  background:#2563eb;
}
</style>
</head>

<body>

<div class="max-w-7xl mx-auto px-6 py-6">

<!-- HEADER -->
<div class="flex justify-between items-center mb-6">
  <div>
    <h1 class="text-3xl font-bold">ðŸ›¡ CyberMonitor</h1>
    <p class="text-gray-400 text-sm">USB Monitoring & Security Dashboard</p>
  </div>

  <div class="flex gap-2">
    <button onclick="downloadAgent()" class="bg-blue-600 px-4 py-2 rounded-lg">â¬‡ Agent</button>
    <button onclick="downloadSetup()" class="bg-indigo-600 px-4 py-2 rounded-lg">âš™ Setup</button>
    <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded-lg">Logout</button>
  </div>
</div>

<!-- TABS -->
<div class="flex gap-2 mb-6">
  <button class="tab-btn active px-4 py-2 rounded-lg" onclick="openTab('monitor')">Monitoring</button>
  <button class="tab-btn px-4 py-2 rounded-lg" onclick="openTab('logs')">Logs</button>
  <button class="tab-btn px-4 py-2 rounded-lg" onclick="openTab('profile')">Profile</button>
</div>

<!-- MONITOR TAB -->
<div id="monitor" class="tab glass p-5 rounded-xl">
  <h2 class="text-xl font-semibold mb-4">Connected USB Devices</h2>
  <table class="w-full text-sm">
    <thead class="text-cyan-300 border-b border-gray-700">
      <tr>
        <th class="text-left py-2">Device</th>
        <th class="text-left py-2">Risk</th>
        <th class="text-left py-2">Time</th>
      </tr>
    </thead>
    <tbody id="usbTable"></tbody>
  </table>
</div>

<!-- LOGS TAB -->
<div id="logs" class="tab glass p-5 rounded-xl hidden">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
    <h2 class="text-xl font-semibold">USB Activity Logs</h2>

    <div class="flex gap-2">
      <input type="date" id="filterDate"
        class="bg-black/40 border border-gray-700 rounded px-3 py-1 text-sm">
      <button onclick="printLogs()" class="bg-green-600 px-3 py-1 rounded">ðŸ–¨ Print</button>
    </div>
  </div>

  <div id="logBox" class="max-h-80 overflow-y-auto text-sm"></div>
</div>

<!-- PROFILE TAB -->
<div id="profile" class="tab glass p-5 rounded-xl hidden">
  <h2 class="text-xl font-semibold mb-4">Profile</h2>
  <div id="profileInfo" class="text-sm grid md:grid-cols-2 gap-4"></div>
</div>

</div>

<script>
/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
  authDomain: "cybermonitor-1ab3c.firebaseapp.com",
  projectId: "cybermonitor-1ab3c",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------------- AUTH ---------------- */
const email = localStorage.getItem("login_email");
if(!email){
  document.body.innerHTML="<h2 class='text-center text-red-500 mt-20'>Unauthorized</h2>";
  throw new Error("Not logged in");
}
const uid = email.replace(/@/g,"_").replace(/\./g,"_");

/* ---------------- NAV ---------------- */
function openTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.add("hidden"));
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById(tab).classList.remove("hidden");
  event.target.classList.add("active");
}

function logout(){
  localStorage.removeItem("login_email");
  location.href="login.html";
}
function downloadAgent(){ location.href="monitor.py"; }
function downloadSetup(){ location.href="setup_usb_monitor.bat"; }

/* ---------------- STATUS / PROFILE ---------------- */
db.collection("users").doc(uid).onSnapshot(doc=>{
  const d=doc.data();
  document.getElementById("profileInfo").innerHTML=`
    <div><b>Email:</b> ${d.email}</div>
    <div><b>Machine:</b> ${d.machine}</div>
    <div><b>Status:</b> ${d.is_online?"ðŸŸ¢ Online":"ðŸ”´ Offline"}</div>
    <div><b>Last Seen:</b> ${new Date(d.last_seen).toLocaleString()}</div>
  `;
});

/* ---------------- USB MONITOR ---------------- */
db.collection("users").doc(uid).collection("usb_status")
.orderBy("timestamp","desc")
.onSnapshot(snap=>{
  let html="";
  snap.forEach(doc=>{
    const d=doc.data();
    html+=`
      <tr class="border-b border-gray-800 hover:bg-white/5">
        <td class="py-2">${d.name}</td>
        <td class="py-2">${d.risk}</td>
        <td class="py-2">${new Date(d.timestamp).toLocaleString()}</td>
      </tr>`;
  });
  document.getElementById("usbTable").innerHTML=
    html||"<tr><td colspan='3' class='py-3 text-gray-400'>No USB activity</td></tr>";
});

/* ---------------- LOGS + FILTER ---------------- */
let allLogs=[];

db.collection("users").doc(uid).collection("logs")
.orderBy("timestamp","desc")
.onSnapshot(snap=>{
  allLogs=[];
  snap.forEach(doc=>allLogs.push(doc.data()));
  renderLogs();
});

document.getElementById("filterDate").addEventListener("change",renderLogs);

function renderLogs(){
  const selectedDate = document.getElementById("filterDate").value;
  let html = "";

  allLogs.forEach(d => {
    const localDate = new Date(d.timestamp).toLocaleDateString("en-CA");

    if (selectedDate && localDate !== selectedDate) return;

    html += `
      <div class="mb-2">
        <b>${d.event}</b> â€” ${d.device}<br>
        <span class="text-xs text-gray-400">
          ${new Date(d.timestamp).toLocaleString()}
        </span>
        <hr class="border-gray-800 mt-2">
      </div>
    `;
  });

  document.getElementById("logBox").innerHTML =
    html || "<p class='text-gray-400'>No logs found</p>";
}


/* ---------------- PRINT ---------------- */
function printLogs(){
  const win=window.open("","","width=800,height=600");
  win.document.write(`<h2>CyberMonitor USB Logs</h2>`+document.getElementById("logBox").innerHTML);
  win.print();
}
</script>

</body>
</html>
