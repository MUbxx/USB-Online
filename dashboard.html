<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, onSnapshot, collection
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
  authDomain: "cybermonitor-1ab3c.firebaseapp.com",
  projectId: "cybermonitor-1ab3c"
};

const FIXED_UID = "MXXq4tHL35hzKi9PJytPCXWDSzn1";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= STATUS ================= */
onSnapshot(doc(db, "users", FIXED_UID), snap => {
  if (!snap.exists()) return;
  const f = snap.data().fields;

  email.innerText   = f.email?.stringValue || "-";
  machine.innerText = f.machine?.stringValue || "-";
  status.innerText  = f.is_online?.booleanValue ? "ONLINE ðŸŸ¢" : "OFFLINE ðŸ”´";

  if (f.last_seen?.timestampValue) {
    lastSeen.innerText =
      new Date(f.last_seen.timestampValue).toLocaleString();
  }
});

/* ================= USB ================= */
onSnapshot(
  doc(db, "users", FIXED_UID, "status", "usb_status"),
  snap => {
    usbTable.innerHTML = "";
    if (!snap.exists()) return;

    const arr = snap.data().fields.usb_devices?.arrayValue?.values || [];
    arr.forEach(v => {
      const f = v.mapValue.fields;
      usbTable.innerHTML += `
        <tr>
          <td>${f.device_name.stringValue}</td>
          <td>${f.token.stringValue}</td>
        </tr>`;
    });
  }
);

/* ================= LOGS ================= */
onSnapshot(collection(db, "users", FIXED_UID, "logs"), snap => {
  logs.innerHTML = "";
  snap.docs
    .sort((a,b)=>
      b.data().fields.timestamp.timestampValue
      .localeCompare(a.data().fields.timestamp.timestampValue))
    .forEach(d => {
      const f = d.data().fields;
      logs.innerHTML += `<div>[${f.severity.stringValue}] ${f.message.stringValue}</div>`;
    });
});
</script>

<style>
body {
  background:#0b1020;
  color:#fff;
  font-family:system-ui;
  padding:20px;
}
.card {
  background:#111833;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}
table { width:100%; border-collapse:collapse }
td { padding:6px; border-bottom:1px solid #222 }
</style>
</head>

<body>

<div class="card">
  <h2>CyberMonitor Dashboard</h2>
  <small>UID fixed: <b>MXXq4tHL35hzKi9PJytPCXWDSzn1</b></small>
</div>

<div class="card">
  <h3>Status</h3>
  Email: <span id="email"></span><br>
  Machine: <span id="machine"></span><br>
  Status: <span id="status"></span><br>
  Last Seen: <span id="lastSeen"></span>
</div>

<div class="card">
  <h3>External USB Devices</h3>
  <table>
    <tbody id="usbTable"></tbody>
  </table>
</div>

<div class="card">
  <h3>Logs</h3>
  <div id="logs"></div>
</div>

</body>
</html>
