<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CyberMonitor Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<style>
body{background:#0b1220;font-family: 'Inter', sans-serif;}
.card{background:#101a33;border:1px solid #1e2b4d;border-radius:18px;}
.indicator-online{background:#16a34a;}
.indicator-offline{background:#dc2626;}
.toast{position:fixed;right:25px;bottom:25px;background:#0f172a;color:white;padding:14px 16px;border-radius:12px;border:1px solid #1e293b;opacity:0.95;z-index:50;}
</style>
</head>

<body class="text-gray-200">

<!-- HEADER -->
<div class="w-full p-5 flex justify-between items-center card mb-6">
  <div>
    <h1 class="text-2xl font-bold">CyberMonitor Dashboard</h1>
    <p class="text-gray-400 text-sm mt-1">USB Device Protection & Realtime Monitoring</p>
  </div>
  <div class="flex items-center gap-4 relative">
    <div class="flex items-center gap-2 cursor-pointer" onclick="toggleProfile()">
      <span id="connectionDot" class="w-3 h-3 rounded-full indicator-offline"></span>
      <p id="connectionStatus">Agent Offline</p>
    </div>
    <button id="profileBtn" class="px-3 py-1 bg-blue-600 rounded-lg hover:bg-blue-700 text-white text-sm">Profile</button>
  </div>
</div>

<!-- PROFILE MODAL -->
<div id="profileModal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">
  <div class="bg-[#101a33] rounded-xl p-6 w-96 relative">
    <h2 class="text-xl font-semibold mb-4">Profile</h2>
    <p><strong>First Name:</strong> <span id="firstName">Loading...</span></p>
    <p><strong>Last Name:</strong> <span id="lastName">Loading...</span></p>
    <p><strong>Email:</strong> <span id="profileEmail">Loading...</span></p>
    <p><strong>Phone:</strong> <span id="phone">Loading...</span></p>

    <div class="mt-4 flex justify-between">
      <button onclick="logout()" class="px-3 py-1 bg-red-600 rounded-lg hover:bg-red-700 text-white">Logout</button>
      <button onclick="closeProfile()" class="px-3 py-1 bg-gray-700 rounded-lg hover:bg-gray-800 text-white">Close</button>
    </div>
  </div>
</div>

<!-- DOWNLOAD AGENT -->
<div class="card p-5 mb-6 flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-start">
    <h2 class="text-xl font-semibold mr-4">Download Agent:</h2>
    <a href="monitor.py" download
       class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Python Agent (.py)</a>
    <a href="install.bat" download
       class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white">Installer (.bat)</a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 px-4">

    <!-- USB DEVICES -->
    <div class="card p-5">
        <h2 class="text-xl font-semibold mb-3">Connected USB Devices</h2>
        <table class="w-full text-sm table-auto">
            <thead>
                <tr class="text-gray-400">
                    <th class="text-left py-2">Vendor</th>
                    <th class="text-left py-2">Product</th>
                    <th class="text-left py-2">Serial</th>
                    <th class="text-left py-2">Class</th>
                    <th class="text-left py-2">Status</th>
                    <th class="text-left py-2">Action</th>
                </tr>
            </thead>
            <tbody id="deviceTable"></tbody>
        </table>
    </div>

    <!-- REALTIME LOGS -->
    <div class="card p-5">
        <h2 class="text-xl font-semibold mb-3">Realtime Logs</h2>
        <div id="logBox" class="bg-black/40 h-80 overflow-y-auto p-3 rounded-lg text-xs">
            Loading logs...
        </div>
    </div>

</div>

<!-- WHITELIST MANAGER -->
<div class="card p-5 m-4 mt-6">
    <h2 class="text-xl font-semibold mb-3">Whitelist Manager</h2>
    <div class="flex gap-3 mb-3">
        <input id="whitelistInput" type="text" placeholder="Enter Serial / VID:PID"
               class="w-full p-2 rounded-lg bg-black/30 border border-gray-700 text-white">
        <button onclick="addWhitelist()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white">
            Add
        </button>
    </div>
    <ul id="whitelistList" class="text-sm"></ul>
</div>

<!-- Toast container -->
<div id="toastContainer"></div>

<script>
// ---------------- Firebase Setup ----------------
const firebaseConfig = {
  apiKey: "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
  authDomain: "cybermonitor-1ab3c.firebaseapp.com",
  projectId: "cybermonitor-1ab3c",
  storageBucket: "cybermonitor-1ab3c.appspot.com",
  messagingSenderId: "569408987884",
  appId: "1:569408987884:web:0839eb7932c206fc157bc9",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const functions = firebase.functions();

let uid = null;
let knownDevices = new Set();

// ---------------- PROFILE MODAL ----------------
function toggleProfile(){document.getElementById("profileModal").classList.toggle("hidden");}
function closeProfile(){document.getElementById("profileModal").classList.add("hidden");}

// ---------------- LOGOUT ----------------
function logout(){
    auth.signOut().then(()=>{window.location.href="login.html";});
}

// ---------------- INIT DASHBOARD ----------------
auth.onAuthStateChanged(async user=>{
    if(user){
        uid=user.uid;
        loadProfile(user);
        initDashboard();
    }else{
        window.location.href="login.html";
    }
});

async function loadProfile(user){
    const profileDoc = await db.collection("users").doc(uid).get();
    const data = profileDoc.exists? profileDoc.data() : {};
    document.getElementById("firstName").innerText = data.first_name || "N/A";
    document.getElementById("lastName").innerText = data.last_name || "N/A";
    document.getElementById("phone").innerText = data.phone || "N/A";
    document.getElementById("profileEmail").innerText = user.email;
}

function initDashboard(){
    updateStatus();
    updateDevices();
    updateLogs();
    loadWhitelist();

    setInterval(updateStatus,2000);
    setInterval(updateDevices,2500);
    setInterval(updateLogs,2000);
    setInterval(loadWhitelist,5000);
}

// ---------------- STATUS ----------------
async function updateStatus(){
    const doc = await db.collection("users").doc(uid).get();
    if(!doc.exists) return;
    const data = doc.data();
    const dot=document.getElementById("connectionDot");
    const text=document.getElementById("connectionStatus");
    if(data.online){dot.className="w-3 h-3 rounded-full indicator-online";text.innerText="Agent Online";}
    else{dot.className="w-3 h-3 rounded-full indicator-offline";text.innerText="Agent Offline";}
}

// ---------------- DEVICES ----------------
async function updateDevices(){
    const usbDoc=await db.collection("users").doc(uid).collection("status").doc("usb_status").get();
    if(!usbDoc.exists) return;
    const devices=usbDoc.data().usb_devices||[];
    const tbody=document.getElementById("deviceTable");
    tbody.innerHTML="";
    devices.forEach(dev=>{
        const key=dev.serial||dev.device_name;
        if(!knownDevices.has(key)){
            showToast("New USB detected: "+key);
            sendEmailAlert(dev);
            knownDevices.add(key);
        }
        const tr=document.createElement("tr");
        tr.innerHTML=`<td class="py-2">${dev.vendor||"—"}</td>
                      <td class="py-2">${dev.product||dev.device_name||"—"}</td>
                      <td class="py-2">${dev.serial||"—"}</td>
                      <td class="py-2">${dev.class||"Mass Storage"}</td>
                      <td class="py-2">${dev.whitelisted?"Whitelisted":"Untrusted"}</td>
                      <td class="py-2">
                        <button onclick="blockDevice('${dev.serial}')" class="px-3 py-1 bg-red-600 rounded-lg hover:bg-red-700 text-white">Block</button>
                        <button onclick="allowDevice('${dev.serial}')" class="px-3 py-1 bg-green-600 rounded-lg hover:bg-green-700 text-white ml-2">Allow</button>
                      </td>`;
        tbody.appendChild(tr);
    });
}

// ---------------- LOGS ----------------
async function updateLogs(){
    const logsSnap=await db.collection("users").doc(uid).collection("logs").orderBy("timestamp","desc").limit(50).get();
    const box=document.getElementById("logBox");
    let html="";
    logsSnap.forEach(l=>{
        const d=l.data();
        const t=new Date(d.timestamp*1000).toLocaleTimeString();
        html+=`[${t}] ${d.device_name} (${d.device_serial}) → ${d.action}<br>`;
    });
    box.innerHTML=html;
    box.scrollTop=box.scrollHeight;
}

// ---------------- WHITELIST ----------------
async function loadWhitelist(){
    const wlDoc=await db.collection("users").doc(uid).collection("config").doc("whitelist").get();
    const ul=document.getElementById("whitelistList");
    ul.innerHTML="";
    const devices=wlDoc.exists && wlDoc.data().devices ? wlDoc.data().devices : [];
    devices.forEach(d=>{
        const li=document.createElement("li");
        li.className="flex justify-between py-1";
        li.innerHTML=`${d} <button onclick="removeWhitelist('${d}')" class="text-red-400 hover:text-red-600">remove</button>`;
        ul.appendChild(li);
    });
}
async function addWhitelist(){
    const val=document.getElementById("whitelistInput").value;
    if(!val) return;
    const wlRef=db.collection("users").doc(uid).collection("config").doc("whitelist");
    await wlRef.set({devices: firebase.firestore.FieldValue.arrayUnion(val)},{merge:true});
    document.getElementById("whitelistInput").value="";
    loadWhitelist();
}
async function removeWhitelist(val){
    const wlRef=db.collection("users").doc(uid).collection("config").doc("whitelist");
    await wlRef.update({devices: firebase.firestore.FieldValue.arrayRemove(val)});
    loadWhitelist();
}

// ---------------- BLOCK / ALLOW DEVICE ----------------
async function blockDevice(serial){
    const blkRef=db.collection("users").doc(uid).collection("config").doc("blocked");
    await blkRef.set({devices: firebase.firestore.FieldValue.arrayUnion(serial)},{merge:true});
    showToast("Device blocked: "+serial);
}
async function allowDevice(serial){
    const blkRef=db.collection("users").doc(uid).collection("config").doc("blocked");
    await blkRef.update({devices: firebase.firestore.FieldValue.arrayRemove(serial)});
    showToast("Device allowed: "+serial);
}

// ---------------- EMAIL ALERT ----------------
async function sendEmailAlert(dev){
    try{
        const sendEmailFunc=functions.httpsCallable("sendDeviceAlert"); // Firebase Cloud Function
        await sendEmailFunc({
            userUid: uid,
            deviceName: dev.device_name,
            serial: dev.serial,
            vendor: dev.vendor||"Unknown",
            product: dev.product||"Unknown",
            class: dev.class||"Mass Storage"
        });
    }catch(e){console.error("Email alert error:",e);}
}

// ---------------- TOAST ----------------
function showToast(msg){
    const t=document.createElement("div");
    t.className="toast";
    t.innerText=msg;
    document.getElementById("toastContainer").appendChild(t);
    setTimeout(()=>t.remove(),4000);
}
</script>

</body>
</html>
