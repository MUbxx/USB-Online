<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Security Dashboard</title>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{
    font-family: 'Inter', sans-serif;
    background:#0b1220;
}
.card{
    background:#101a33;
    border:1px solid #1e2b4d;
    border-radius:18px;
}
.indicator-online{
    background:#16a34a;
}
.indicator-offline{
    background:#dc2626;
}
.toast{
    position:fixed;
    right:25px;
    bottom:25px;
    background:#0f172a;
    color:white;
    padding:14px 16px;
    border-radius:12px;
    border:1px solid #1e293b;
    opacity:0.95;
}
</style>
</head>

<body class="text-gray-200">

<!-- NAVBAR -->
<div class="w-full p-5 flex justify-between items-center card mb-4">
    <div>
        <h1 class="text-2xl font-bold">Security Monitoring Dashboard</h1>
        <p class="text-sm text-gray-400">USB Device Protection & Realtime Monitoring</p>
    </div>

    <div class="flex gap-8">
        <div>
            <p class="text-gray-400 text-sm">Active User</p>
            <p id="activeUser" class="font-semibold">Loading...</p>
        </div>

        <div>
            <p class="text-gray-400 text-sm">Host Machine</p>
            <p id="activeHost" class="font-semibold">Loading...</p>
        </div>

        <div class="flex items-center gap-2">
            <span id="connectionDot" class="w-3 h-3 rounded-full indicator-offline"></span>
            <p id="connectionStatus">Agent Offline</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 px-4">

    <!-- USB DEVICE LIST -->
    <div class="card p-5">
        <h2 class="text-xl font-semibold mb-3">Connected USB Devices</h2>
        <table class="w-full text-sm">
            <thead>
                <tr class="text-gray-400">
                    <th class="text-left py-2">Vendor</th>
                    <th class="text-left py-2">Product</th>
                    <th class="text-left py-2">Serial</th>
                    <th class="text-left py-2">Status</th>
                    <th class="text-left py-2">Action</th>
                </tr>
            </thead>
            <tbody id="deviceTable"></tbody>
        </table>
    </div>

    <!-- REALTIME LOG STREAM -->
    <div class="card p-5">
        <h2 class="text-xl font-semibold mb-3">Realtime Logs</h2>

        <div id="logBox" class="bg-black/40 h-80 overflow-y-auto p-3 rounded-lg text-xs">
        </div>
    </div>

</div>

<!-- WHITELIST MANAGER -->
<div class="card p-5 m-4 mt-6">
    <h2 class="text-xl font-semibold mb-3">Whitelist Manager</h2>

    <div class="flex gap-3 mb-3">
        <input id="whitelistInput" type="text" placeholder="Enter Serial / VID:PID"
               class="w-full p-2 rounded-lg bg-black/30 border border-gray-700">

        <button onclick="addWhitelist()"
                class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700">
            Add
        </button>
    </div>

    <ul id="whitelistList" class="text-sm"></ul>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

<script>
async function fetchJSON(url){
    try{
        const r = await fetch(url);
        return await r.json();
    }catch{
        return null;
    }
}

/* ---------------- LIVE STATUS ---------------- */
async function updateStatus(){
    const status = await fetchJSON("/api/status");
    const dot = document.getElementById("connectionDot");
    const text = document.getElementById("connectionStatus");

    if(status && status.online){
        dot.className = "w-3 h-3 rounded-full indicator-online";
        text.innerText = "Agent Online";
    } else {
        dot.className = "w-3 h-3 rounded-full indicator-offline";
        text.innerText = "Agent Offline";
    }
}

/* ---------------- USER / HOST ---------------- */
async function updateUserInfo(){
    const info = await fetchJSON("/api/userinfo");

    document.getElementById("activeUser").innerText = info?.user || "unknown";
    document.getElementById("activeHost").innerText = info?.host || "unknown";
}

/* ---------------- DEVICES TABLE ---------------- */
let knownDevices = new Set();

async function updateDevices(){
    const data = await fetchJSON("/api/devices");
    const tbody = document.getElementById("deviceTable");
    tbody.innerHTML = "";

    if(!data) return;

    data.devices.forEach(dev=>{
        const key = dev.serial || dev.product+dev.vendor;

        if(!knownDevices.has(key)){
            showToast("New USB device detected: " + (dev.serial || "unknown serial"));
            knownDevices.add(key);
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="py-2">${dev.vendor}</td>
            <td class="py-2">${dev.product}</td>
            <td class="py-2">${dev.serial || "â€”"}</td>
            <td class="py-2">${dev.whitelisted ? "Whitelisted" : "Untrusted"}</td>
            <td class="py-2">
                <button onclick="blockDevice('${dev.serial}')"
                        class="px-3 py-1 bg-red-600 rounded-lg">
                    Block
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* ---------------- BLOCK DEVICE ---------------- */
async function blockDevice(serial){
    await fetch("/api/block",{
        method:"POST",
        headers:{ "Content-Type":"application/json"},
        body:JSON.stringify({serial})
    });
    showToast("Device blocked: "+serial);
}

/* ---------------- LOG STREAM ---------------- */
async function updateLogs(){
    const logs = await fetchJSON("/api/logs");
    const box = document.getElementById("logBox");

    if(!logs) return;

    box.innerHTML = logs.join("<br>");
    box.scrollTop = box.scrollHeight;
}

/* ---------------- WHITELIST ---------------- */
async function loadWhitelist(){
    const list = await fetchJSON("/api/whitelist");
    const ul = document.getElementById("whitelistList");
    ul.innerHTML = "";

    list.items.forEach(item=>{
        const li = document.createElement("li");
        li.className="flex justify-between py-1";

        li.innerHTML = `
            ${item}
            <button onclick="removeWhitelist('${item}')" class="text-red-400">
                remove
            </button>
        `;
        ul.appendChild(li);
    });
}

async function addWhitelist(){
    const value = document.getElementById("whitelistInput").value;
    await fetch("/api/whitelist",{
        method:"POST",
        headers:{ "Content-Type":"application/json"},
        body:JSON.stringify({value})
    });

    document.getElementById("whitelistInput").value = "";
    loadWhitelist();
}

async function removeWhitelist(value){
    await fetch("/api/whitelist",{
        method:"DELETE",
        headers:{ "Content-Type":"application/json"},
        body:JSON.stringify({value})
    });
    loadWhitelist();
}

/* ---------------- TOAST ALERTS ---------------- */
function showToast(msg){
    const t = document.createElement("div");
    t.className="toast";
    t.innerText = msg;
    document.getElementById("toastContainer").appendChild(t);

    setTimeout(()=>t.remove(),4000);
}

/* ---------------- INTERVAL REFRESH ---------------- */
updateStatus();
updateUserInfo();
updateDevices();
updateLogs();
loadWhitelist();

setInterval(updateStatus, 2000);
setInterval(updateDevices, 2500);
setInterval(updateLogs, 2000);
</script>

</body>
</html>
