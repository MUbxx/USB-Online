<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
  authDomain: "cybermonitor-1ab3c.firebaseapp.com",
  projectId: "cybermonitor-1ab3c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ðŸ”’ FIXED UID (matches agent)
const UID = "MXXq4tHL35hzKi9PJytPCXWDSzn1";

/* ================= STATUS ================= */
onSnapshot(doc(db, "users", UID), snap => {
  if (!snap.exists()) return;
  const f = snap.data().fields;

  document.getElementById("email").innerText =
    f.email?.stringValue || "-";

  document.getElementById("machine").innerText =
    f.machine?.stringValue || "-";

  document.getElementById("status").innerText =
    f.is_online?.booleanValue ? "ONLINE ðŸŸ¢" : "OFFLINE ðŸ”´";

  document.getElementById("lastSeen").innerText =
    f.last_seen?.timestampValue
      ? new Date(f.last_seen.timestampValue).toLocaleString()
      : "-";
});

/* ================= USB ================= */
onSnapshot(doc(db, "users", UID, "status", "usb_status"), snap => {
  const tbody = document.getElementById("usbBody");
  tbody.innerHTML = "";
  if (!snap.exists()) return;

  const arr = snap.data().fields.usb_devices?.arrayValue?.values || [];
  arr.forEach(d => {
    const f = d.mapValue.fields;
    tbody.innerHTML += `
      <tr>
        <td>${f.device_name.stringValue}</td>
        <td>${f.token.stringValue}</td>
      </tr>`;
  });
});

/* ================= LOGS ================= */
onSnapshot(collection(db, "users", UID, "logs"), snap => {
  const box = document.getElementById("logs");
  box.innerHTML = "";
  snap.docs
    .sort((a,b) =>
      b.data().fields.timestamp.timestampValue.localeCompare(
        a.data().fields.timestamp.timestampValue))
    .forEach(d => {
      const f = d.data().fields;
      box.innerHTML += `<div>[${f.severity.stringValue}] ${f.message.stringValue}</div>`;
    });
});
</script>

<style>
body { background:#0b1020; color:#fff; font-family:Arial; padding:20px }
.card { background:#111933; padding:15px; margin-bottom:20px; border-radius:10px }
table { width:100%; border-collapse:collapse }
td,th { padding:8px; border-bottom:1px solid #333 }
</style>
</head>

<body>

<h1>CyberMonitor Dashboard</h1>
<p>UID fixed: <b>MXXq4tHL35hzKi9PJytPCXWDSzn1</b></p>

<div class="card">
  <h3>Status</h3>
  Email: <span id="email"></span><br>
  Machine: <span id="machine"></span><br>
  Status: <span id="status"></span><br>
  Last Seen: <span id="lastSeen"></span>
</div>

<div class="card">
  <h3>External USB Devices</h3>
  <table>
    <tr><th>Device</th><th>Token</th></tr>
    <tbody id="usbBody"></tbody>
  </table>
</div>

<div class="card">
  <h3>Logs</h3>
  <div id="logs"></div>
</div>

</body>
</html>
