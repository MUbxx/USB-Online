<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CyberMonitor Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { background: #0b1220; font-family: 'Inter', sans-serif; color: #e5e7eb; }
.card { background:#101a33; border:1px solid #1e2b4d; border-radius:16px; }
.indicator-online { background: #16a34a; box-shadow: 0 0 10px #16a34a; }
.indicator-offline { background: #dc2626; box-shadow: 0 0 10px #dc2626; }
.toast { position: fixed; right: 25px; bottom: 25px; background: #1e293b; color:white; padding:14px 16px; border-radius:12px; border:1px solid #3b82f6; z-index:100; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
</style>
</head>
<body class="flex h-screen overflow-hidden">

<div class="w-64 bg-[#101a33] flex flex-col p-5 border-r border-gray-800">
    <h1 class="text-2xl font-bold mb-10 text-blue-500">CyberMonitor</h1>
    <ul class="flex flex-col gap-4 text-gray-400">
        <li><button onclick="showSection('dashboardSection')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-600 hover:text-white transition">Dashboard</button></li>
        <li><button onclick="showSection('usbSection')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-600 hover:text-white transition">USB Devices</button></li>
        <li><button onclick="showSection('logsSection')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-600 hover:text-white transition">Security Logs</button></li>
        <li><button onclick="toggleProfile()" class="w-full text-left px-4 py-2 rounded hover:bg-blue-600 hover:text-white transition">Edit Profile</button></li>
    </ul>
    <button onclick="logout()" class="mt-auto w-full bg-red-600/10 text-red-500 border border-red-600/30 hover:bg-red-600 hover:text-white rounded py-2 transition">Logout</button>
</div>

<div class="flex-1 p-10 overflow-y-auto">
    
    <div id="dashboardSection" class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="card p-6">
            <p class="text-gray-500 text-sm font-medium">AGENT STATUS</p>
            <div class="flex items-center gap-3 mt-3">
                <span id="connectionDot" class="w-3 h-3 rounded-full indicator-offline"></span>
                <span id="connectionStatus" class="text-lg font-bold">Checking...</span>
            </div>
        </div>
        <div class="card p-6">
            <p class="text-gray-500 text-sm font-medium">LOGGED USER</p>
            <p id="activeUser" class="text-xl font-bold mt-2">...</p>
        </div>
        <div class="card p-6">
            <p class="text-gray-500 text-sm font-medium">MACHINE NAME</p>
            <p id="activeHost" class="text-xl font-bold mt-2">...</p>
        </div>
    </div>

    <div id="usbSection" class="hidden card mt-10 p-6">
        <h2 class="text-xl font-bold mb-6">Connected Peripherals</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="text-gray-500 border-b border-gray-800">
                    <tr>
                        <th class="pb-4">Device Model</th>
                        <th class="pb-4">Serial Number</th>
                        <th class="pb-4">Status</th>
                        <th class="pb-4">Control</th>
                    </tr>
                </thead>
                <tbody id="deviceTable" class="divide-y divide-gray-800"></tbody>
            </table>
        </div>
    </div>

    <div id="logsSection" class="hidden card mt-10 p-6">
        <h2 class="text-xl font-bold mb-4">Real-time Events</h2>
        <div id="logBox" class="h-80 overflow-y-auto bg-black/40 rounded-lg p-5 font-mono text-xs text-blue-300 space-y-2"></div>
    </div>
</div>

<div id="profileModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex justify-center items-center z-50">
    <div class="card p-8 w-[400px] border-blue-500/30">
        <h2 class="text-2xl font-bold mb-6 text-center">Modify Profile</h2>
        <div class="space-y-5">
            <div>
                <label class="text-xs text-gray-500 uppercase font-bold">First Name</label>
                <input id="editFirstName" type="text" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 mt-1 focus:border-blue-500 outline-none">
            </div>
            <div>
                <label class="text-xs text-gray-500 uppercase font-bold">Last Name</label>
                <input id="editLastName" type="text" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 mt-1 focus:border-blue-500 outline-none">
            </div>
            <div>
                <label class="text-xs text-gray-500 uppercase font-bold">Phone</label>
                <input id="editPhone" type="text" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 mt-1 focus:border-blue-500 outline-none">
            </div>
        </div>
        <div class="flex gap-4 mt-8">
            <button onclick="saveProfile()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold transition">Update</button>
            <button onclick="toggleProfile()" class="flex-1 bg-gray-800 py-3 rounded-lg transition">Close</button>
        </div>
    </div>
</div>

<div id="toastContainer"></div>

<script>
const firebaseConfig = {apiKey:"AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",authDomain:"cybermonitor-1ab3c.firebaseapp.com",projectId:"cybermonitor-1ab3c",storageBucket:"cybermonitor-1ab3c.appspot.com",messagingSenderId:"569408987884",appId:"1:569408987c206fc157bc9"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();
let uid=null;

auth.onAuthStateChanged(user => {
    if(user){ uid=user.uid; startApp(); }
    else{ window.location.href="login.html"; }
});

function startApp(){
    listenToStatus();
    listenToDevices();
    listenToLogs();
}

function listenToStatus(){
    db.collection("users").doc(uid).onSnapshot(doc => {
        const data = doc.data();
        if(!data) return;
        
        document.getElementById("activeUser").innerText = data.active_user || "No Session";
        document.getElementById("activeHost").innerText = data.machine || "None";
        
        // Populate profile fields
        if(!document.getElementById("editFirstName").value) {
            document.getElementById("editFirstName").value = data.first_name || "";
            document.getElementById("editLastName").value = data.last_name || "";
            document.getElementById("editPhone").value = data.phone || "";
        }

        // Offline logic (15s threshold)
        const lastSeen = data.last_seen ? data.last_seen.toMillis() : 0;
        const online = (Date.now() - lastSeen) < 15000;
        
        const dot = document.getElementById("connectionDot");
        const status = document.getElementById("connectionStatus");
        dot.className = online ? "w-3 h-3 rounded-full indicator-online" : "w-3 h-3 rounded-full indicator-offline";
        status.innerText = online ? "Agent Online" : "Agent Offline";
    });
}

async function saveProfile(){
    try {
        await db.collection("users").doc(uid).update({
            first_name: document.getElementById("editFirstName").value,
            last_name: document.getElementById("editLastName").value,
            phone: document.getElementById("editPhone").value
        });
        showToast("Profile Updated Successfully");
        toggleProfile();
    } catch(e) { showToast("Error saving profile"); }
}

function listenToDevices(){
    db.collection("users").doc(uid).collection("status").doc("usb_status").onSnapshot(doc => {
        const list = doc.data()?.usb_devices || [];
        const tbody = document.getElementById("deviceTable");
        tbody.innerHTML = "";
        list.forEach(d => {
            tbody.innerHTML += `
                <tr>
                    <td class="py-4"><b>${d.vendor}</b><br><span class="text-xs text-gray-500">${d.device_name}</span></td>
                    <td class="py-4 font-mono text-xs">${d.serial}</td>
                    <td class="py-4"><span class="bg-green-500/10 text-green-500 px-2 py-1 rounded text-xs border border-green-500/20">Active</span></td>
                    <td class="py-4"><button class="text-red-500 text-xs hover:underline">Revoke Access</button></td>
                </tr>`;
        });
    });
}

function listenToLogs(){
    db.collection("users").doc(uid).collection("logs").orderBy("timestamp", "desc").limit(15).onSnapshot(snap => {
        const box = document.getElementById("logBox");
        box.innerHTML = "";
        snap.forEach(doc => {
            const l = doc.data();
            const t = l.timestamp ? l.timestamp.toDate().toLocaleTimeString() : "...";
            box.innerHTML += `<p><span class="opacity-50">[${t}]</span> ${l.message}</p>`;
        });
    });
}

function showSection(id){
    ["dashboardSection","usbSection","logsSection"].forEach(s=>document.getElementById(s).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
}

function toggleProfile(){ document.getElementById("profileModal").classList.toggle("hidden"); }
function showToast(m){ 
    const t = document.createElement("div"); t.className="toast"; t.innerText=m; 
    document.getElementById("toastContainer").appendChild(t);
    setTimeout(()=>t.remove(), 3000);
}
function logout(){ auth.signOut(); }
</script>
</body>
</html>
