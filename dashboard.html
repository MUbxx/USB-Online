<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#020617;
  color:#e5e7eb;
  font-family:Segoe UI, Arial;
}
.card{
  background:#020c1b;
  padding:18px;
  border-radius:14px;
  margin-bottom:18px;
  box-shadow:0 0 18px rgba(0,255,255,0.08);
}
.logs{
  max-height:260px;
  overflow-y:auto;
  background:#020617;
  padding:10px;
  border-radius:8px;
}
</style>
</head>

<body class="min-h-screen">

<div class="max-w-5xl mx-auto p-6">

<h1 class="text-3xl font-bold mb-4">ðŸ–¥ CyberMonitor Dashboard</h1>

<p class="text-gray-400 mb-4">
Logged in as: <span id="userEmail" class="text-cyan-400"></span>
</p>

<div class="card" id="status">Loading statusâ€¦</div>

<div class="card">
  <h2 class="text-xl mb-2 font-semibold">Connected USB Devices</h2>
  <table class="w-full text-sm">
    <thead>
      <tr class="text-cyan-300">
        <th class="text-left p-1">Device</th>
        <th class="text-left p-1">Risk</th>
        <th class="text-left p-1">Timestamp</th>
      </tr>
    </thead>
    <tbody id="usbTable"></tbody>
  </table>
</div>

<div class="card">
  <h2 class="text-xl mb-2 font-semibold">USB Event Logs</h2>
  <div id="logBox" class="logs text-sm">Loading logsâ€¦</div>
</div>

<button onclick="logout()"
 class="mt-3 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">
Logout
</button>

</div>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
  authDomain: "cybermonitor-1ab3c.firebaseapp.com",
  projectId: "cybermonitor-1ab3c",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------------- GET EMAIL FROM LOGIN ---------------- */
const email = localStorage.getItem("login_email");

if(!email){
  document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:40px'>Not Authorized â€” Please Login First</h2>";
  throw new Error("No login email found");
}

document.getElementById("userEmail").innerText = email;

/* convert email â†’ UID (same as Python script) */
const uid = email.replace(/@/g,"_").replace(/\./g,"_");

/* ---------------- LOGOUT ---------------- */
function logout(){
  localStorage.removeItem("login_email");
  window.location.href = "login.html";
}

/* ---------------- STATUS CARD ---------------- */
db.collection("users").doc(uid).onSnapshot(doc=>{
  if(!doc.exists){
    document.getElementById("status").innerHTML = "<span style='color:red'>User not found in database.</span>";
    return;
  }

  const d = doc.data();

  document.getElementById("status").innerHTML = `
    <b>Email:</b> ${d.email}<br>
    <b>Machine:</b> ${d.machine}<br>
    <b>Status:</b> ${d.is_online ? "ðŸŸ¢ ONLINE" : "ðŸ”´ OFFLINE"}<br>
    <b>Last Seen:</b> ${new Date(d.last_seen).toLocaleString()}
  `;
});

/* ---------------- USB DEVICES ---------------- */
db.collection("users").doc(uid).collection("usb_status")
.orderBy("timestamp","desc").onSnapshot(snapshot=>{
  let html="";
  snapshot.forEach(doc=>{
    const d = doc.data();
    html += `
      <tr>
        <td class="p-1">${d.name}</td>
        <td class="p-1">${d.risk}</td>
        <td class="p-1">${new Date(d.timestamp).toLocaleString()}</td>
      </tr>`;
  });
  document.getElementById("usbTable").innerHTML = html || `<tr><td colspan="3">No USB records</td></tr>`;
});

/* ---------------- LOGS ---------------- */
db.collection("users").doc(uid).collection("logs")
.orderBy("timestamp","desc").limit(50).onSnapshot(snapshot=>{
  let html="";
  snapshot.forEach(doc=>{
    const d = doc.data();
    html += `
      <div class="mb-1">
        <b>${d.event}</b> â€” ${d.device}<br>
        <span class="text-gray-400 text-xs">${new Date(d.timestamp).toLocaleString()}</span>
        <hr class="border-gray-700 mt-1">
      </div>`;
  });
  document.getElementById("logBox").innerHTML = html || "No logs yet.";
});
</script>

</body>
</html>
