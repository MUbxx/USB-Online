<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#020617;
  color:#e5e7eb;
  font-family:Segoe UI, Arial;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:20px;
}
.card{
  background:#020c1b;
  padding:15px;
  border-radius:10px;
  margin-bottom:18px;
  box-shadow:0 0 18px rgba(0,255,255,0.15);
}
.logs{
  max-height:250px;
  overflow-y:auto;
  background:#020617;
  padding:10px;
  border-radius:8px;
}
.top{
  display:flex;
  justify-content:space-between;
}
.btn{padding:8px 14px;border-radius:7px;border:none;background:#0ea5e9;color:white}
.btn.red{background:#ef4444}
</style>
</head>

<body>

<div class="container">

<div class="top">
  <h1>ðŸ–¥ CyberMonitor Dashboard</h1>
  <div>
    <button class="btn" onclick="downloadMonitor()">â¬‡ Download Monitor</button>
    <button class="btn red" onclick="logout()">ðŸšª Logout</button>
  </div>
</div>

<div class="card" id="status">Loadingâ€¦</div>

<div class="card">
  <h2>Connected USB Devices</h2>
  <table width="100%">
    <thead>
      <tr><th>Device</th><th>Risk</th><th>Time</th></tr>
    </thead>
    <tbody id="usbTable"></tbody>
  </table>
</div>

<div class="card">
  <h2>USB Logs</h2>
  <div id="logBox" class="logs">Loading logsâ€¦</div>
</div>

</div>

<script>
/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* AUTO UID DETECTION */
async function getUID(){

  // 1) try file created by monitor.py
  try{
    const r = await fetch("uid.json");
    const j = await r.json();
    localStorage.setItem("usb_uid", j.uid);
    return j.uid;
  }catch(e){}

  // 2) try browser saved UID
  const saved = localStorage.getItem("usb_uid");
  if(saved) return saved;

  document.body.innerHTML="<h2 style='color:red'>UID not found. Run monitor.py first.</h2>";
}

let uidPromise = getUID();

uidPromise.then(uid=>{

/* DOWNLOAD BUTTON */
window.downloadMonitor = ()=> window.location.href="monitor.py";

/* LOGOUT */
window.logout = ()=>{
  localStorage.removeItem("usb_uid");
  alert("Logged out");
  location.reload();
};

/* STATUS */
db.collection("users").doc(uid).onSnapshot(doc=>{
  const d = doc.data();
  document.getElementById("status").innerHTML = `
    <b>Email:</b> ${d.email}<br>
    <b>Machine:</b> ${d.machine}<br>
    <b>Status:</b> ${d.is_online ? "ðŸŸ¢ ONLINE" : "ðŸ”´ OFFLINE"}<br>
    <b>Last Seen:</b> ${new Date(d.last_seen).toLocaleString()}
  `;
});

/* USB DEVICES */
db.collection("users").doc(uid).collection("usb_status")
.orderBy("timestamp","desc").onSnapshot(snap=>{
  let html="";
  snap.forEach(doc=>{
    const d = doc.data();
    html += `<tr>
      <td>${d.name}</td>
      <td>${d.risk}</td>
      <td>${new Date(d.timestamp).toLocaleString()}</td>
    </tr>`;
  });
  document.getElementById("usbTable").innerHTML = html || "<tr><td colspan=3>No devices</td></tr>";
});

/* LOGS */
db.collection("users").doc(uid).collection("logs")
.orderBy("timestamp","desc").limit(40).onSnapshot(snap=>{
  let html="";
  snap.forEach(doc=>{
    const d=doc.data();
    html += `<div><b>${d.event}</b> â€” ${d.device}<br>
      <small>${new Date(d.timestamp).toLocaleString()}</small><hr></div>`;
  });
  document.getElementById("logBox").innerHTML=html;
});

});
</script>

</body>
</html>
