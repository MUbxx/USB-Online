<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>USB Monitor Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
    background:#0b0f14;
    color:#e5e7eb;
    font-family:Arial;
    padding:20px;
}
.card {
    background:#111827;
    padding:15px;
    border-radius:8px;
    margin-bottom:15px;
}
.low {color:#22c55e;}
.medium {color:#eab308;}
.high {color:#ef4444;}
</style>
</head>

<body>

<h2>USB Monitoring Dashboard</h2>

<div class="card" id="status">Loading status...</div>
<div class="card" id="usb">Loading USB devices...</div>
<div class="card" id="logs">Loading logs...</div>

<script>
/* ================= CONFIG ================= */

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= UID ================= */

const params = new URLSearchParams(window.location.search);
const uid = params.get("uid");

if (!uid) {
  document.body.innerHTML = "<h2 style='color:red'>UID missing in URL</h2>";
  throw new Error("UID missing");
}

/* ================= STATUS ================= */

db.collection("users").doc(uid).onSnapshot(doc => {
    if (!doc.exists) return;
    const d = doc.data();
    document.getElementById("status").innerHTML = `
        <b>Email:</b> ${d.email}<br>
        <b>Machine:</b> ${d.machine}<br>
        <b>Status:</b> ${d.is_online ? "ONLINE ðŸŸ¢" : "OFFLINE ðŸ”´"}<br>
        <b>Last Seen:</b> ${new Date(d.last_seen).toLocaleString()}
    `;
});

/* ================= USB ================= */

db.collection("users").doc(uid)
.collection("usb_status")
.onSnapshot(snapshot => {
    let html = "<b>Connected USB Devices</b><br><br>";
    snapshot.forEach(doc => {
        const d = doc.data();
        html += `
        <div>
          ${d.name}<br>
          <span class="${d.risk.toLowerCase()}">${d.risk}</span>
          <small> (${new Date(d.timestamp).toLocaleString()})</small>
        </div><hr>`;
    });
    document.getElementById("usb").innerHTML = html;
});

/* ================= LOGS ================= */

db.collection("users").doc(uid)
.collection("logs")
.orderBy("timestamp","desc")
.limit(20)
.onSnapshot(snapshot => {
    let html = "<b>USB Activity Logs</b><br><br>";
    snapshot.forEach(doc => {
        const d = doc.data();
        html += `
        <div>
          ${d.event} â€” ${d.device}<br>
          <small>${new Date(d.timestamp).toLocaleString()}</small>
        </div><hr>`;
    });
    document.getElementById("logs").innerHTML = html;
});
</script>

</body>
</html>
