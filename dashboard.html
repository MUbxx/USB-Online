<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CyberMonitor Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<style>
body { background: #0b1220; font-family: 'Inter', sans-serif; color: #e5e7eb; }
.card { background:#101a33;border:1px solid #1e2b4d;border-radius:16px; }
.indicator-online { background: #16a34a; }
.indicator-offline { background: #dc2626; }
.toast { position: fixed; right: 25px; bottom: 25px; background: #0f172a; color:white; padding:14px 16px; border-radius:12px; border:1px solid #1e293b; opacity:0.95; z-index:50; }
</style>
</head>
<body class="flex h-screen overflow-hidden">

<!-- SIDE NAV -->
<div class="w-64 bg-[#101a33] flex flex-col p-4">
    <h1 class="text-2xl font-bold mb-6">CyberMonitor</h1>
    <ul class="flex flex-col gap-3 text-gray-300">
        <li><button onclick="showSection('dashboardSection')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-700">Dashboard</button></li>
        <li><button onclick="showSection('usbSection')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-700">USB Devices</button></li>
        <li><button onclick="showSection('logsSection')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-700">Logs</button></li>
        <li><button onclick="showSection('whitelistSection')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-700">Whitelist</button></li>
        <li><button onclick="toggleProfile()" class="w-full text-left px-3 py-2 rounded hover:bg-blue-700">Profile</button></li>
    </ul>
    <div class="mt-auto">
        <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 rounded px-3 py-2">Logout</button>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="flex-1 p-6 overflow-y-auto space-y-6">

<!-- DASHBOARD SUMMARY -->
<div id="dashboardSection" class="space-y-4">
    <div class="flex flex-wrap gap-4">
        <div class="card p-4 flex-1 min-w-[220px]">
            <p class="text-gray-400">Agent Status</p>
            <div class="flex items-center gap-2 mt-2">
                <span id="connectionDot" class="w-3 h-3 rounded-full indicator-offline"></span>
                <span id="connectionStatus">Offline</span>
            </div>
        </div>
        <div class="card p-4 flex-1 min-w-[220px]">
            <p class="text-gray-400">Active User</p>
            <p id="activeUser" class="text-lg font-semibold mt-2">Loading...</p>
        </div>
        <div class="card p-4 flex-1 min-w-[220px]">
            <p class="text-gray-400">Host Machine</p>
            <p id="activeHost" class="text-lg font-semibold mt-2">Loading...</p>
        </div>
        <div class="card p-4 flex-1 min-w-[220px]">
            <p class="text-gray-400">Download Agent</p>
            <div class="flex gap-2 mt-2">
                <a href="monitor.py" download class="px-3 py-1 bg-blue-600 rounded hover:bg-blue-700 text-white">Python</a>
                <a href="install.bat" download class="px-3 py-1 bg-green-600 rounded hover:bg-green-700 text-white">Installer</a>
            </div>
        </div>
    </div>
</div>

<!-- USB DEVICES -->
<div id="usbSection" class="hidden card p-4">
    <h2 class="text-xl font-semibold mb-3">Connected USB Devices</h2>
    <table class="w-full text-sm table-auto">
        <thead>
            <tr class="text-gray-400">
                <th class="py-2 text-left">Vendor</th>
                <th class="py-2 text-left">Product</th>
                <th class="py-2 text-left">Serial</th>
                <th class="py-2 text-left">Class</th>
                <th class="py-2 text-left">Status</th>
                <th class="py-2 text-left">Actions</th>
            </tr>
        </thead>
        <tbody id="deviceTable"></tbody>
    </table>
</div>

<!-- LOGS -->
<div id="logsSection" class="hidden card p-4">
    <h2 class="text-xl font-semibold mb-3">Realtime Logs</h2>
    <div id="logBox" class="h-80 overflow-y-auto bg-black/30 p-3 rounded text-xs">Loading logs...</div>
</div>

<!-- WHITELIST -->
<div id="whitelistSection" class="hidden card p-4">
    <h2 class="text-xl font-semibold mb-3">Whitelist Manager</h2>
    <div class="flex gap-2 mb-3">
        <input id="whitelistInput" type="text" placeholder="Serial / VID:PID" class="flex-1 p-2 rounded bg-black/20 border border-gray-600">
        <button onclick="addWhitelist()" class="px-3 py-1 bg-blue-600 rounded hover:bg-blue-700">Add</button>
    </div>
    <ul id="whitelistList" class="text-sm"></ul>
</div>

<!-- PROFILE MODAL -->
<div id="profileModal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">
  <div class="bg-[#101a33] rounded-xl p-6 w-96 relative">
    <h2 class="text-xl font-semibold mb-4">Profile</h2>
    <p><strong>First Name:</strong> <span id="firstName">Loading...</span></p>
    <p><strong>Last Name:</strong> <span id="lastName">Loading...</span></p>
    <p><strong>Email:</strong> <span id="profileEmail">Loading...</span></p>
    <p><strong>Phone:</strong> <span id="phone">Loading...</span></p>
    <div class="mt-4 flex justify-between">
        <button onclick="logout()" class="px-3 py-1 bg-red-600 rounded hover:bg-red-700 text-white">Logout</button>
        <button onclick="closeProfile()" class="px-3 py-1 bg-gray-700 rounded hover:bg-gray-800 text-white">Close</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toastContainer"></div>

<script>
const firebaseConfig = {apiKey:"AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",authDomain:"cybermonitor-1ab3c.firebaseapp.com",projectId:"cybermonitor-1ab3c",storageBucket:"cybermonitor-1ab3c.appspot.com",messagingSenderId:"569408987884",appId:"1:569408987c206fc157bc9"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore(), functions=firebase.functions();
let uid=null, knownDevices=new Set();

function toggleProfile(){document.getElementById("profileModal").classList.toggle("hidden");}
function closeProfile(){document.getElementById("profileModal").classList.add("hidden");}
function showSection(id){["dashboardSection","usbSection","logsSection","whitelistSection"].forEach(s=>document.getElementById(s).classList.add("hidden")); document.getElementById(id).classList.remove("hidden");}
function logout(){auth.signOut().then(()=>{window.location.href="login.html";});}

auth.onAuthStateChanged(async user=>{
    if(user){uid=user.uid; loadProfile(user); initDashboard();}
    else{window.location.href="login.html";}
});

async function loadProfile(user){
    const profileDoc=await db.collection("users").doc(uid).get();
    const data=profileDoc.exists?profileDoc.data():{};
    document.getElementById("firstName").innerText=data.first_name||"N/A";
    document.getElementById("lastName").innerText=data.last_name||"N/A";
    document.getElementById("phone").innerText=data.phone||"N/A";
    document.getElementById("profileEmail").innerText=user.email;
}

function initDashboard(){
    updateStatus(); updateDevices(); updateLogs(); loadWhitelist();
    setInterval(updateStatus,2000); setInterval(updateDevices,2500); setInterval(updateLogs,2000); setInterval(loadWhitelist,5000);
}

async function updateStatus(){
    const doc=await db.collection("users").doc(uid).get();
    if(!doc.exists) return;
    const data=doc.data();
    const dot=document.getElementById("connectionDot"), text=document.getElementById("connectionStatus");
    if(data.online){dot.className="w-3 h-3 rounded-full indicator-online";text.innerText="Agent Online";}
    else{dot.className="w-3 h-3 rounded-full indicator-offline";text.innerText="Agent Offline";}
    document.getElementById("activeUser").innerText=data.active_user||"unknown";
    document.getElementById("activeHost").innerText=data.machine||"unknown";
}

async function updateDevices(){
    const usbDoc=await db.collection("users").doc(uid).collection("status").doc("usb_status").get();
    if(!usbDoc.exists) return;
    const devices=usbDoc.data().usb_devices||[];
    const tbody=document.getElementById("deviceTable"); tbody.innerHTML="";
    devices.forEach(dev=>{
        const key=dev.serial||dev.device_name;
        if(!knownDevices.has(key)){showToast("New USB: "+key); knownDevices.add(key);}
        const tr=document.createElement("tr");
        tr.innerHTML=`<td class="py-2">${dev.vendor||"—"}</td>
        <td class="py-2">${dev.device_name||"—"}</td>
        <td class="py-2">${dev.serial||"—"}</td>
        <td class="py-2">${dev.class||"Mass Storage"}</td>
        <td class="py-2">${dev.whitelisted?"Whitelisted":dev.blocked?"Blocked":"Untrusted"}</td>
        <td class="py-2">
            <button onclick="blockDevice('${dev.serial}')" class="px-2 py-1 bg-red-600 rounded hover:bg-red-700 text-white">Block</button>
            <button onclick="allowDevice('${dev.serial}')" class="px-2 py-1 bg-green-600 rounded hover:bg-green-700 text-white ml-2">Allow</button>
        </td>`;
        tbody.appendChild(tr);
    });
}

// Add updateLogs(), loadWhitelist(), addWhitelist(), removeWhitelist(), blockDevice(), allowDevice(), sendToast()...
// For brevity, similar as previous code snippet.
</script>
</body>
</html>
