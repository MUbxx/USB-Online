<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{background:#020617;color:white;font-family:Arial;margin:0}
.card{background:#0f172a;margin:12px;padding:15px;border-radius:12px;border:1px solid #1f2937}
.badge-online{color:#10b981}
.badge-offline{color:#ef4444}
.time{font-family:monospace;color:#a5b4fc}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #1f2937}
</style>
</head>

<body>

<div class="card">
  <h2>CyberMonitor Dashboard</h2>
  UID fixed: <b>MXXq4tHL35hzKi9PJytPCXWDSzn1</b>
</div>

<div class="card">
  <h3>Status</h3>
  <p><b>Email:</b> <span id="email"></span></p>
  <p><b>Machine:</b> <span id="machine"></span></p>
  <p><b>Status:</b> <span id="status"></span></p>
  <p><b>Last Seen:</b> <span class="time" id="last_seen"></span></p>
</div>

<div class="card">
  <h3>External USB Devices</h3>
  <table id="usb_table">
    <tr><th>Device</th><th>Token</th></tr>
  </table>
</div>

<div class="card">
  <h3>Logs</h3>
  <div id="logs"></div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
  projectId:"cybermonitor-1ab3c"
});

const db=firebase.firestore();
const UID="MXXq4tHL35hzKi9PJytPCXWDSzn1";

function toIST(utc){
 let d=new Date(utc);
 let t=new Date(d.getTime()+5.5*60*60*1000);
 return t.toLocaleString("en-IN",{hour12:false}).replace(",","");
}

db.doc(`users/${UID}`).onSnapshot(doc=>{
 if(!doc.exists)return;
 let d=doc.data();

 document.getElementById("email").innerText=d.email||"";
 document.getElementById("machine").innerText=d.machine||"";
 document.getElementById("last_seen").innerText=d.last_seen?toIST(d.last_seen):"";

 let last=new Date(d.last_seen||0);
 let diff=(new Date()-last)/1000;

 document.getElementById("status").innerHTML=
   diff<12?"<span class='badge-online'>ONLINE</span>"
          :"<span class='badge-offline'>OFFLINE</span>";
});

db.doc(`users/${UID}/status/usb_status`).onSnapshot(doc=>{
 const t=document.getElementById("usb_table");
 t.innerHTML="<tr><th>Device</th><th>Token</th></tr>";

 if(!doc.exists)return;

 let arr=doc.data().usb_devices?.values||[];

 arr.forEach(v=>{
  let f=v.mapValue.fields;
  let tr=document.createElement("tr");
  tr.innerHTML=`<td>${f.device_name.stringValue}</td><td>${f.token.stringValue}</td>`;
  t.appendChild(tr);
 });
});

db.collection(`users/${UID}/logs`).orderBy("timestamp","desc").limit(50).onSnapshot(s=>{
 const box=document.getElementById("logs");
 box.innerHTML="";
 s.forEach(doc=>{
  let d=doc.data();
  let div=document.createElement("div");
  div.innerHTML=`<span class="time">${toIST(d.timestamp)}</span> â€” ${d.message}`;
  box.appendChild(div);
 });
});
</script>

</body>
</html>
