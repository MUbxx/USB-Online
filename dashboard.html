<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { background:#020617; color:#e5e7eb; }
.card {
  background:#020c1b;
  padding:18px;
  border-radius:14px;
  margin-bottom:18px;
}
.logs {
  max-height:260px;
  overflow-y:auto;
  background:#020617;
  padding:10px;
  border-radius:8px;
}
</style>
</head>

<body>

<div class="max-w-6xl mx-auto p-6">

<div class="flex justify-between items-center mb-4">
  <h1 class="text-3xl font-bold">ðŸ–¥ CyberMonitor Dashboard</h1>
  <div class="space-x-2">
    <button onclick="downloadAgent()" class="bg-blue-600 px-4 py-2 rounded">
      â¬‡ Download Agent
    </button>
    <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded">
      Logout
    </button>
  </div>
</div>

<p class="text-gray-400 mb-4">
Logged in as <span id="userEmail" class="text-cyan-400"></span>
</p>

<div class="card" id="status">Loading statusâ€¦</div>

<div class="card">
  <h2 class="text-xl mb-2">Connected USB Devices</h2>
  <table class="w-full text-sm">
    <thead class="text-cyan-300">
      <tr>
        <th>Device</th>
        <th>Risk</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody id="usbTable"></tbody>
  </table>
</div>

<div class="card">
  <h2 class="text-xl mb-2">USB Logs</h2>
  <div id="logBox" class="logs"></div>
</div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
  authDomain: "cybermonitor-1ab3c.firebaseapp.com",
  projectId: "cybermonitor-1ab3c",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const email = localStorage.getItem("login_email");
if(!email){
  document.body.innerHTML =
    "<h2 class='text-red-500 text-center mt-20'>Unauthorized â€“ Please Login</h2>";
  throw new Error("Not logged in");
}

document.getElementById("userEmail").innerText = email;
const uid = email.replace(/@/g,"_").replace(/\./g,"_");

function logout(){
  localStorage.removeItem("login_email");
  window.location.href = "login.html";
}

function downloadAgent(){
  window.location.href = "monitor.py"; // host this file
}

// STATUS
db.collection("users").doc(uid).onSnapshot(doc=>{
  const d = doc.data();
  document.getElementById("status").innerHTML = `
    <b>Email:</b> ${d.email}<br>
    <b>Machine:</b> ${d.machine}<br>
    <b>Status:</b> ${d.is_online ? "ðŸŸ¢ ONLINE" : "ðŸ”´ OFFLINE"}<br>
    <b>Last Seen:</b> ${new Date(d.last_seen).toLocaleString()}
  `;
});

// USB TABLE
db.collection("users").doc(uid).collection("usb_status")
.orderBy("timestamp","desc").onSnapshot(snap=>{
  let html="";
  snap.forEach(doc=>{
    const d = doc.data();
    html += `<tr>
      <td>${d.name}</td>
      <td>${d.risk}</td>
      <td>${new Date(d.timestamp).toLocaleString()}</td>
    </tr>`;
  });
  document.getElementById("usbTable").innerHTML =
    html || "<tr><td colspan='3'>No devices</td></tr>";
});

// LOGS
db.collection("users").doc(uid).collection("logs")
.orderBy("timestamp","desc").limit(50).onSnapshot(snap=>{
  let html="";
  snap.forEach(doc=>{
    const d = doc.data();
    html += `<div>
      <b>${d.event}</b> â€” ${d.device}<br>
      <span class="text-xs text-gray-400">
        ${new Date(d.timestamp).toLocaleString()}
      </span>
      <hr class="border-gray-700 my-1">
    </div>`;
  });
  document.getElementById("logBox").innerHTML = html;
});
</script>

</body>
</html>
