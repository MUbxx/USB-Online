<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CyberMonitor Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{background:#0b1220;font-family:'Inter',sans-serif;color:#e5e7eb;}
.card{background:#101a33;border:1px solid #1e2b4d;border-radius:16px;}
.indicator-online{background:#16a34a;box-shadow:0 0 10px #16a34a;}
.indicator-offline{background:#dc2626;box-shadow:0 0 10px #dc2626;}
</style>
</head>

<body class="flex h-screen">

<div class="w-64 bg-[#101a33] p-5 flex flex-col border-r border-gray-800">
    <h1 class="text-2xl font-bold text-blue-400 mb-10">CyberMonitor</h1>

    <button onclick="showSection('dashboard')" class="mb-3">Dashboard</button>
    <button onclick="showSection('usb')" class="mb-3">USB Devices</button>
    <button onclick="showSection('logs')" class="mb-3">Logs</button>
    <button onclick="toggleProfile()" class="mb-3">Profile</button>

    <button onclick="auth.signOut()" class="mt-auto text-red-500">Logout</button>
</div>

<div class="flex-1 p-10 overflow-y-auto">

<div id="dashboard">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">

        <div class="card p-6">
            <p>Status</p>
            <div class="flex gap-2 mt-2">
                <span id="connDot" class="w-3 h-3 rounded-full indicator-offline"></span>
                <span id="connText">Checking...</span>
            </div>
        </div>

        <div class="card p-6">
            <p>Account</p>
            <h2 id="accountName" class="text-xl font-bold mt-2">...</h2>
        </div>

        <div class="card p-6">
            <p>System User</p>
            <h2 id="sysUser" class="text-xl font-bold mt-2">...</h2>
        </div>

        <div class="card p-6">
            <p>Agent Downloads</p>
            <a href="monitor.py" download>Python Agent</a><br>
            <a href="install.bat" download>Installer</a>
        </div>

    </div>
</div>

<div id="usb" class="hidden card p-6 mt-6">
    <h2 class="text-xl font-bold mb-4">USB Devices</h2>
    <table class="w-full">
        <tbody id="usbTable"></tbody>
    </table>
</div>

<div id="logs" class="hidden card p-6 mt-6">
    <h2 class="text-xl font-bold mb-4">Logs</h2>
    <div id="logBox" class="h-80 overflow-y-auto text-xs"></div>
</div>

</div>

<script>
const firebaseConfig={
 apiKey:"AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
 authDomain:"cybermonitor-1ab3c.firebaseapp.com",
 projectId:"cybermonitor-1ab3c",
 storageBucket:"cybermonitor-1ab3c.appspot.com",
 messagingSenderId:"569408987884",
 appId:"1:569408987884:web:0839eb7932c206fc157bc9"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let uid=null;

auth.onAuthStateChanged(user=>{
    if(!user){
        window.location="login.html";
        return;
    }

    uid=user.uid;
    document.getElementById("accountName").innerText=user.email;

    loadStatus();
    loadUSB();
    loadLogs();
});

function loadStatus(){
    db.collection("users").doc(uid).onSnapshot(doc=>{
        const d=doc.data(); if(!d) return;

        document.getElementById("sysUser").innerText=d.active_user||"UNKNOWN";

        let last=0;
        if(typeof d.last_seen==="string") last=new Date(d.last_seen).getTime();

        const online = (Date.now()-last)<15000;

        document.getElementById("connDot").className=
            online?"w-3 h-3 rounded-full indicator-online":"w-3 h-3 rounded-full indicator-offline";

        document.getElementById("connText").innerText=
            online?"Agent Online":"Agent Offline";
    });
}

function loadUSB(){
    db.collection("users").doc(uid).collection("status").doc("usb_status")
    .onSnapshot(doc=>{
        const list=doc.data()?.usb_devices||[];
        const t=document.getElementById("usbTable");
        t.innerHTML="";

        list.forEach(d=>{
            const f=d.mapValue.fields;

            t.innerHTML+=`
            <tr>
                <td>${f.vendor.stringValue}</td>
                <td>${f.device_name.stringValue}</td>
                <td>${f.serial.stringValue}</td>
            </tr>`;
        });
    });
}

function loadLogs(){
    db.collection("users").doc(uid).collection("logs")
    .orderBy("timestamp","desc").limit(30)
    .onSnapshot(s=>{
        const box=document.getElementById("logBox");
        box.innerHTML="";
        s.forEach(doc=>{
            const d=doc.data();
            box.innerHTML+=`<p>${d.message}</p>`;
        });
    });
}

function showSection(id){
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("usb").classList.add("hidden");
    document.getElementById("logs").classList.add("hidden");
    document.getElementById(id).classList.remove("hidden");
}

function toggleProfile(){}

</script>
</body>
</html>
