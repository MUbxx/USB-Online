<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>

<style>
body {
  background:#0b1020;
  color:#fff;
  font-family: Arial, sans-serif;
  padding:20px;
}
.card {
  background:#111933;
  padding:15px;
  margin-bottom:20px;
  border-radius:10px;
}
table {
  width:100%;
  border-collapse:collapse;
}
td, th {
  padding:8px;
  border-bottom:1px solid #333;
}
th {
  text-align:left;
}
</style>
</head>

<body>

<h1>CyberMonitor Dashboard</h1>
<p>UID fixed: <b id="uid"></b></p>

<div class="card">
  <h3>Status</h3>
  Email: <span id="email">-</span><br>
  Machine: <span id="machine">-</span><br>
  Status: <span id="status">-</span><br>
  Last Seen: <span id="lastSeen">-</span>
</div>

<div class="card">
  <h3>External USB Devices</h3>
  <table>
    <thead>
      <tr>
        <th>Device</th>
        <th>Token</th>
      </tr>
    </thead>
    <tbody id="usbBody">
      <tr><td colspan="2">Loading...</td></tr>
    </tbody>
  </table>
</div>

<div class="card">
  <h3>Logs</h3>
  <div id="logs">Loading...</div>
</div>

<script>
/* ================= CONFIG ================= */
const PROJECT_ID = "cybermonitor-1ab3c";
const API_KEY = "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k";
const UID = "MXXq4tHL35hzKi9PJytPCXWDSzn1";
/* ========================================== */

document.getElementById("uid").innerText = UID;

const BASE =
  `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents`;

async function apiGet(path) {
  const r = await fetch(`${BASE}/${path}?key=${API_KEY}`);
  if (!r.ok) {
    console.error("Firestore error:", r.status);
    return null;
  }
  return r.json();
}

/* ================= STATUS ================= */
async function loadStatus() {
  const d = await apiGet(`users/${UID}`);
  if (!d || !d.fields) return;

  const f = d.fields;
  document.getElementById("email").innerText = f.email?.stringValue || "-";
  document.getElementById("machine").innerText = f.machine?.stringValue || "-";
  document.getElementById("status").innerText =
    f.is_online?.booleanValue ? "ONLINE ðŸŸ¢" : "OFFLINE ðŸ”´";
  document.getElementById("lastSeen").innerText =
    f.last_seen?.timestampValue
      ? new Date(f.last_seen.timestampValue).toLocaleString()
      : "-";
}

/* ================= USB (FIXED) ================= */
async function loadUSB() {
  const tbody = document.getElementById("usbBody");
  tbody.innerHTML = "";

  const d = await apiGet(`users/${UID}/status/usb_status`);

  if (!d || !d.fields || !d.fields.usb_devices) {
    tbody.innerHTML =
      "<tr><td colspan='2'>No external USB devices connected</td></tr>";
    return;
  }

  const values =
    d.fields.usb_devices.arrayValue &&
    d.fields.usb_devices.arrayValue.values
      ? d.fields.usb_devices.arrayValue.values
      : [];

  if (values.length === 0) {
    tbody.innerHTML =
      "<tr><td colspan='2'>No external USB devices connected</td></tr>";
    return;
  }

  values.forEach(item => {
    if (!item.mapValue || !item.mapValue.fields) return;

    const f = item.mapValue.fields;
    const name = f.device_name?.stringValue || "Unknown Device";
    const token = f.token?.stringValue || "N/A";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${name}</td>
      <td>${token.slice(0, 45)}...</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ================= LOGS ================= */
async function loadLogs() {
  const box = document.getElementById("logs");
  box.innerHTML = "";

  const d = await apiGet(`users/${UID}/logs`);
  if (!d || !d.documents) {
    box.innerText = "No logs yet";
    return;
  }

  d.documents
    .sort((a, b) =>
      b.fields.timestamp.timestampValue.localeCompare(
        a.fields.timestamp.timestampValue
      )
    )
    .forEach(l => {
      const f = l.fields;
      const div = document.createElement("div");
      div.innerText =
        `[${f.severity.stringValue}] ${f.message.stringValue}`;
      box.appendChild(div);
    });
}

/* ================= REFRESH LOOP ================= */
async function refreshAll() {
  await loadStatus();
  await loadUSB();
  await loadLogs();
}

refreshAll();
setInterval(refreshAll, 3000);
</script>

</body>
</html>
