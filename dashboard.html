<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  font-family: Segoe UI, Arial, sans-serif;
  background: #0b0f1a;
  color: #e6e6e6;
}
.container {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
}
.card {
  background: #131a2a;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
}
h2 { margin: 0 0 10px; }
.online { color: #4caf50; font-weight: bold; }
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #25304a;
}
th { color: #9fb4ff; }
.mono { font-family: Consolas, monospace; font-size: 12px; }
.logs {
  background: #0f1526;
  height: 220px;
  overflow-y: auto;
  padding: 10px;
  border-radius: 8px;
  font-family: Consolas, monospace;
}
.log { margin-bottom: 6px; }
.log.high { color: #ff6b6b; }
.log.info { color: #9cdcfe; }
</style>
</head>

<body>
<div class="container">

<div class="card">
  <h2>Status</h2>
  Email: <b id="email">-</b><br>
  Machine: <b id="machine">-</b><br>
  Status: <span id="online">OFFLINE</span><br>
  Last Seen: <b id="lastSeen">-</b>
</div>

<div class="card">
  <h2>External USB Devices</h2>
  <table>
    <thead>
      <tr>
        <th>Device</th>
        <th>Token</th>
        <th>Connected At</th>
      </tr>
    </thead>
    <tbody id="usbTable"></tbody>
  </table>
</div>

<div class="card">
  <h2>Logs</h2>
  <div id="logBox" class="logs"></div>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API_KEY = "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k";
const PROJECT_ID = "cybermonitor-1ab3c";
const USER_ID = "MXXq4tHL35hzKi9PJytPCXWDSzn1";
/* ========================================= */

const BASE =
  `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents`;

let lastLogTime = null;

/* -------- STATUS -------- */
async function fetchStatus() {
  const r = await fetch(`${BASE}/users/${USER_ID}?key=${API_KEY}`);
  const d = (await r.json()).fields;

  document.getElementById("email").innerText = d.email.stringValue;
  document.getElementById("machine").innerText = d.machine.stringValue;
  document.getElementById("lastSeen").innerText =
    new Date(d.last_seen.timestampValue).toLocaleString();

  document.getElementById("online").innerText =
    d.is_online.booleanValue ? "ONLINE ðŸŸ¢" : "OFFLINE ðŸ”´";
}

/* -------- USB -------- */
async function fetchUSB() {
  const r = await fetch(
    `${BASE}/users/${USER_ID}/status/usb_status?key=${API_KEY}`
  );
  const d = (await r.json()).fields.usb_devices.arrayValue.values || [];

  const tbody = document.getElementById("usbTable");
  tbody.innerHTML = "";

  if (!d.length) {
    tbody.innerHTML = "<tr><td colspan='3'>No external USB devices</td></tr>";
    return;
  }

  d.forEach(x => {
    const f = x.mapValue.fields;
    tbody.innerHTML += `
      <tr>
        <td>${f.device_name.stringValue}</td>
        <td class="mono">${f.token.stringValue.slice(0,30)}...</td>
        <td>${new Date(f.connected_at.timestampValue).toLocaleString()}</td>
      </tr>`;
  });
}

/* -------- LOGS (APPEND ONLY) -------- */
async function fetchLogs() {
  const r = await fetch(
    `${BASE}/users/${USER_ID}/logs?orderBy=timestamp&key=${API_KEY}`
  );
  const docs = (await r.json()).documents || [];

  const box = document.getElementById("logBox");

  docs.forEach(doc => {
    const f = doc.fields;
    const ts = f.timestamp.timestampValue;

    if (lastLogTime && ts <= lastLogTime) return;

    const div = document.createElement("div");
    div.className = `log ${f.severity.stringValue.toLowerCase()}`;
    div.textContent =
      `[${new Date(ts).toLocaleTimeString()}] ${f.message.stringValue}`;
    box.appendChild(div);

    lastLogTime = ts;
  });

  box.scrollTop = box.scrollHeight;
}

/* -------- POLLING -------- */
fetchStatus();
fetchUSB();
fetchLogs();

setInterval(fetchStatus, 4000);
setInterval(fetchUSB, 4000);
setInterval(fetchLogs, 3000);
</script>
</body>
</html>
