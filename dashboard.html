<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberMonitor Dashboard</title>

<style>
body {
  background:#0b1020;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
.card {
  background:#111933;
  padding:15px;
  margin-bottom:20px;
  border-radius:10px;
}
table {
  width:100%;
  border-collapse:collapse;
}
td, th {
  padding:8px;
  border-bottom:1px solid #333;
}
</style>
</head>

<body>

<h1>CyberMonitor Dashboard</h1>
<p>UID fixed: <b id="uid"></b></p>

<div class="card">
  <h3>Status</h3>
  Email: <span id="email">-</span><br>
  Machine: <span id="machine">-</span><br>
  Status: <span id="status">-</span><br>
  Last Seen: <span id="lastSeen">-</span>
</div>

<div class="card">
  <h3>External USB Devices</h3>
  <table>
    <tr><th>Device</th><th>Token</th></tr>
    <tbody id="usbBody"></tbody>
  </table>
</div>

<div class="card">
  <h3>Logs</h3>
  <div id="logs"></div>
</div>

<script>
/* ===== CONFIG (MATCH monitor.py) ===== */
const PROJECT_ID = "cybermonitor-1ab3c";
const API_KEY = "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k";
const UID = "MXXq4tHL35hzKi9PJytPCXWDSzn1";
/* ==================================== */

document.getElementById("uid").innerText = UID;

const BASE =
  `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents`;

async function apiGet(path) {
  const r = await fetch(`${BASE}/${path}?key=${API_KEY}`);
  if (!r.ok) {
    console.error("Firestore error:", r.status);
    return null;
  }
  return r.json();
}

async function loadStatus() {
  const d = await apiGet(`users/${UID}`);
  if (!d) return;

  const f = d.fields;
  document.getElementById("email").innerText = f.email?.stringValue || "-";
  document.getElementById("machine").innerText = f.machine?.stringValue || "-";
  document.getElementById("status").innerText =
    f.is_online?.booleanValue ? "ONLINE ðŸŸ¢" : "OFFLINE ðŸ”´";
  document.getElementById("lastSeen").innerText =
    f.last_seen?.timestampValue
      ? new Date(f.last_seen.timestampValue).toLocaleString()
      : "-";
}

async function loadUSB() {
  const d = await apiGet(`users/${UID}/status/usb_status`);
  if (!d) return;

  const tbody = document.getElementById("usbBody");
  tbody.innerHTML = "";

  const arr = d.fields?.usb_devices?.arrayValue?.values || [];
  arr.forEach(v => {
    const f = v.mapValue.fields;
    tbody.innerHTML += `
      <tr>
        <td>${f.device_name.stringValue}</td>
        <td>${f.token.stringValue}</td>
      </tr>`;
  });
}

async function loadLogs() {
  const d = await apiGet(`users/${UID}/logs`);
  if (!d || !d.documents) return;

  const box = document.getElementById("logs");
  box.innerHTML = "";

  d.documents
    .sort((a,b) =>
      b.fields.timestamp.timestampValue.localeCompare(
        a.fields.timestamp.timestampValue))
    .forEach(l => {
      box.innerHTML +=
        `<div>[${l.fields.severity.stringValue}]
         ${l.fields.message.stringValue}</div>`;
    });
}

async function refresh() {
  await loadStatus();
  await loadUSB();
  await loadLogs();
}

refresh();
setInterval(refresh, 3000);
</script>

</body>
</html>
